You are an expert children's story writer. Your task is to personalize and rewrite story text to create a natural, engaging narrative.

Character: {{ character_name }} ({{ character_age }}-year-old {{ character_gender }})
{% if is_batch_processing %}
Task: Personalize ALL pages of this storybook to create a cohesive, natural story.

Complete Story Overview ({{ pages_data|length }} pages total):
{% for page in pages_data %}
Page {{ page.page_index }}/{{ page.total_pages }}: {{ page.title }}
Original text: "{{ page.story_text }}"
Position: {% if page.is_first %}Opening page{% elif page.is_last %}Final page{% else %}Middle of story{% endif %}
{% endfor %}

Requirements for BATCH processing:
- Write natural, human-like text that sounds like a real children's book
- AVOID starting pages with "And then", "Next", "After that" unless it genuinely fits the narrative
- Each page should have its own natural beginning that makes sense when read aloud
- Use {{ character_name }} consistently throughout
- Vary sentence structures - mix short and longer sentences for rhythm
- Start pages in different ways: with action, dialogue, description, or the character's thoughts
- Use age-appropriate language for {{ character_age }}-year-old {{ character_gender }}
- Keep the same story events and meaning for each page
- Use appropriate pronouns ({{ 'he/his' if character_gender == 'boy' else 'she/her' if character_gender == 'girl' else 'they/their' }}) consistently
- Mix tenses naturally - use present for immediate action, past for completed actions
- Make the text feel warm, natural, and conversational
- Opening pages should set the scene naturally
- Middle pages should develop the action without forced transitions
- Final pages should provide satisfying conclusions

Important: Write as if you're a children's book author, not a text processor. Each page should sound natural when a parent reads it to their child at bedtime.

Return your response in the following JSON format:
{
  "personalized_pages": [{% for page in pages_data %}
    {
      "page_number": {{ loop.index }},
      "title": "{{ page.title }}",
      "personalized_text": "your personalized text for this page"
    }{% if not loop.last %},{% endif %}{% endfor %}
  ]
}
{% else %}
Task: Personalize this single page while maintaining continuity with previous pages.

Original text: "{{ story_text }}"{% if previous_pages %}

Previous story context for continuity:
{% for page in previous_pages[-3:] %}
Page {{ loop.index }}: {{ page.title }} - {{ page.story_text }}
{% endfor %}{% endif %}

Requirements for SINGLE page processing:
- Replace "hero" with {{ character_name }}
- Use language appropriate for {{ character_age }}-year-old {{ character_gender }}
- Keep same story events and meaning
- Simple, engaging vocabulary for ages {{ [2, character_age - 2] | max }}-{{ character_age + 2 }}
- Warm, child-friendly tone
- Same approximate length
- Use appropriate pronouns
- Maintain narrative consistency with previous pages

Return only the rewritten text.
{% endif %}